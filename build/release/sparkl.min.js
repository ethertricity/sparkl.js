!function (a) {
  var b = "_msgid", c = "tabserver.browser.src", d = "tabserver.nodejs.module", e = "browser", f = "nodejs", g = "unknown", h = function (a, b, c) {
    for (var d in a)a.hasOwnProperty(d) && (c && -1 !== c.indexOf(d) || (b[d] = a[d]))
  }, i = function (a, b, c) {
    c.forEach(function (c) {
      var d = a[c];
      b[c] = function () {
        return d.apply(a, arguments)
      }
    })
  }, j = function () {
    var a = g;
    return "undefined" != typeof module ? f : "undefined" != typeof window ? e : (console.log("Execution environment: " + a), a)
  }, k = function () {
    var a = 0;
    return function () {
      return 4294967295 > a ? a++ : a = 0
    }
  };
  if ("undefined" == typeof WebSocket)return void console.error("This browser does not support WebSocket");
  var l, m = function (a, b) {
    var c, d;
    for (c in a)a.hasOwnProperty(c) && (d = a[c], b.call(a, c))
  }, n = function (a, b) {
    this.event = a, this.serviceInstance = b
  };
  n.prototype.value = function (a) {
    var b = this, c = b.serviceInstance.metadata(), d = c.content("field", a), e = d ? d.id() : !1;
    return e ? b.event.content("field", e).content() : !1
  }, n.prototype.values = function () {
    var a, b, c, d, e = this, f = e.serviceInstance.metadata(), g = e.event.content("field"), h = {};
    for (a = 0; a < g.length; a++)b = g[a], c = b.id(), d = f.content("field", c).name(), h[d] = b.content();
    return h
  };
  var o = function (a) {
    this.serviceInstance = a, this.fieldValues = {}
  };
  o.prototype.value = function (a, b) {
    var c = this, d = c.serviceInstance.metadata(), e = d.content("field", a), f = e.id();
    return c.fieldValues[f] = b, c
  }, o.prototype.values = function (a) {
    var b, c, d = this;
    for (b in a)a.hasOwnProperty(b) && (c = a[b], d.value(b, c));
    return d
  };
  var p = function (a) {
    this.url = a, this.pendingReplies = {}, this.pendingResponses = {}, this.nextRequestId = k(), this.nextSolicitId = k(), this.ws = null, this.serviceInstances = {}, this.eventHandler = new q(this, ["preopen", "open"]), this.eventHandler.delegate()
  };
  p.READYSTATE_CONNECTING = 0, p.READYSTATE_OPEN = 1, p.READYSTATE_CLOSING = 2, p.READYSTATE_CLOSED = 3, p.prototype.isWebSocketOpen = function () {
    var a = this;
    return a.ws && a.ws.readyState === p.READYSTATE_OPEN
  }, p.prototype.openWebSocket = function (a) {
    var b = this;
    return new Promise(function (c, d) {
      console.log("Opening: " + b.url), b.ws = new WebSocket(b.url + "/" + a), b.ws.onopen = function () {
        console.log("Websocket opened"), c()
      }, b.ws.onclose = function () {
        console.log("Websocket closed"), b.onClose()
      }, b.ws.onmessage = function (a) {
        b.onMessage(a)
      }, b.ws.onerror = function () {
        l = "Failed to open websocket", console.error(l), d(l)
      }
    })
  }, p.prototype.open = function (a) {
    var b = this;
    return new Promise(function (c, d) {
      b.isWebSocketOpen() ? b.sendMessageAwaitAck({tag: "open", serviceId: a}).then(function () {
        c()
      }, function (a) {
        console.error(a.reason()), d("Rejected: " + a.reason())
      }) : b.openWebSocket(a).then(function () {
        c()
      }, function (b) {
        l = "Service: " + a + ", error: " + b, console.error(l), d(l)
      })
    })
  }, p.prototype.onClose = function () {
    var a = this;
    m(a.serviceInstances, function (a) {
      a.onClose()
    }), a.fireEvent("close"), console.log("Closed all service instances")
  }, p.prototype.sendMessage = function (a) {
    var b = this;
    b.ws.send(JSON.stringify(a))
  }, p.prototype.sendMessageAwaitAck = function (a) {
    var c = this;
    return new Promise(function (d, e) {
      var f = "req" + c.nextRequestId(), g = h || 5e3, h = setTimeout(function () {
        l = "Timeout" + f, delete c.pendingReplies[f], console.error(l), e(l)
      }, g), i = {msgid: f, fulfil: d, reject: e, timeout: h};
      c.pendingReplies[f] = i, a[b] = f, c.ws.send(JSON.stringify(a))
    })
  }, p.prototype.onMessage = function (a) {
    var c = this, d = new D.Struct(a.data), e = d.attr(b), f = e ? c.pendingReplies[e] : !1;
    if (f)delete c.pendingReplies[d._msgid()], clearTimeout(f.timeout), "error" === d.tag() ? f.reject(d) : "ok" === d.tag() && f.fulfil(d); else if ("open-event" === d.tag())c.createNewServiceInstance(d); else {
      var g = c.serviceInstances[d.instanceId()];
      g ? g.enqueue(d) : (l = "Invalid instance ID: " + d.instanceId(), console.error(l))
    }
  }, p.prototype.createNewServiceInstance = function (a) {
    var b = this, c = a.instanceId(), d = new A(b, a);
    console.log("Opening instance: " + c), b.serviceInstances[c] = d, b.fireEvent("preopen", d), d.open().then(function () {
      b.fireEvent("open", d)
    }, function (a) {
      console.error("Failed to open service instance: " + a)
    })
  };
  var q = function (a, b) {
    if (!(b instanceof Array))throw"Must specify array of event types";
    this.source = a, this.eventTypes = b, this.listeners = []
  };
  q.prototype.delegate = function () {
    var a = this;
    a.source.on = function (b, c) {
      return a.on(b, c)
    }, a.source.fireEvent = function (b, c) {
      return a.fireEvent(b, c)
    }
  }, q.prototype.on = function (a, b) {
    var c = this;
    return "all" === a || c.eventTypes.indexOf(a) >= 0 ? c.listeners.push({
      eventType: a,
      callback: b
    }) : console.log("Supported event types: " + c.eventTypes.join(",")), c.source
  }, q.prototype.fireEvent = function (a, b) {
    var c, d, e = this, f = e.source, g = new r(f, a, b), h = e.listeners;
    for (c = 0; c < h.length; c++)if (d = h[c], "all" === d.eventType || d.eventType === a)try {
      d.callback.call(e.source, g)
    } catch (i) {
      console.error(i)
    }
  };
  var r = function (a, b, c) {
    this.source = a, this.type = b, this.data = c
  }, s = function (a) {
    this.isRunning = a ? !0 : !1, this.queue = []
  };
  s.prototype.push = function (a) {
    var b = this, c = function () {
      a(function () {
        b.next.call(b)
      })
    };
    b.queue.push(c), b.isRunning || b.next()
  }, s.prototype.next = function () {
    var a = this, b = a.queue.shift();
    b ? (a.isRunning = !0, setTimeout(b, 0)) : a.isRunning = !1
  };
  var t = function (a, b) {
    o.call(this, b), this.op = a
  };
  t.prototype = new o, t.prototype.send = function (a, b) {
    var c = this, d = c.op.id(), e = c.fieldValues;
    c.serviceInstance.notify(d, e).then(a, b)
  };
  var u = function (a, b) {
    n.call(this, a, b), this.opTag = "one-way"
  };
  u.prototype = new n, u.prototype.opId = function () {
    return this.event.opId()
  };
  var v = function (a, b) {
    o.call(this, b), this.requestEvent = a
  };
  v.prototype = new o, v.prototype.set = function (a) {
    var b = this;
    return b.setName = a, b
  }, v.prototype.send = function (a, b) {
    var c = this;
    c.serviceInstance.reply(c.requestEvent, c.setName, c.fieldValues).then(a, b)
  };
  var w = function (a, b) {
    n.call(this, a, b)
  };
  w.prototype = new n, w.prototype.opId = function () {
    return this.event.opId()
  };
  var x = function (a, b) {
    n.call(this, a, b)
  };
  x.prototype = new n;
  var y = function (a, b) {
    this.serviceInstance = a, h(b, this), i(a, this, ["metadata"])
  };
  y.prototype.onInit = function () {
    console.log("No implementation onInit()")
  }, y.prototype.onClose = function () {
    console.log("No implementation onClose()")
  }, y.prototype.onOneWay = function (a) {
    var b = this, c = b.metadata(), d = new u(a, b.serviceInstance), e = d.opId(), f = c.content("one-way", e).name();
    if ("function" == typeof b[f])try {
      b[f].call(b, d)
    } catch (g) {
      console.error(g)
    } else l = "Missing implementation: " + f, console.error(l)
  }, y.prototype.onRequest = function (a) {
    var b = this, c = b.metadata(), d = new w(a, b.serviceInstance), e = d.opId(), f = c.content("request-reply", e), g = f ? f.name() : !1, h = new v(a, b.serviceInstance);
    if (g && "function" == typeof b[g])try {
      b[g].apply(b, [d, h])
    } catch (i) {
      console.error(i)
    } else g ? (l = "Missing implementation: " + g, console.error(l)) : (l = "Unrecognized op id: " + a.opId(), console.error(l))
  }, y.prototype.solicit = function (a) {
    var b = this.serviceInstance;
    return new B(a, b)
  }, y.prototype.notify = function (a) {
    var b = this.serviceInstance;
    return new t(a, b)
  };
  var z = new s, A = function (a, b) {
    this.connection = a, this.openEvent = b, this.eventQueue = new s(!0), this.resolver = null, this.serviceImpl = void 0, this.pendingResponses = {}, this.aggregateEvents = [], this.eventHandler = new q(this, ["aggregate", "close", "notification", "one-way", "request", "reply", "solicit", "response"]), this.eventHandler.delegate()
  };
  A.prototype.setResolver = function (a) {
    var b = this;
    console.log("A URL resolver has been set"), b.resolver = a
  }, A.prototype.enqueue = function (a) {
    var b = this, c = function (c) {
      b.handleEvent(a), c()
    };
    b.eventQueue.push(c)
  }, A.prototype.handleEvent = function (a) {
    var b = this;
    "aggregate-event" === a.tag() ? b.onAggregate(a) : "one-way-event" === a.tag() ? b.onOneWay(a) : "request-event" === a.tag() ? b.onRequest(a) : "response-event" === a.tag() ? b.onResponse(a) : "close-event" === a.tag() ? b.onClose(a) : (l = "Unexpected: " + a.tag(), console.warn(l))
  }, A.prototype.open = function () {
    var a = this;
    return new Promise(function (b, c) {
      var d = function (d) {
        a.loadImplJavascript().then(function () {
          try {
            console.log("Load complete"), d(), a.onInit(a.openEvent), a.eventQueue.next(), b()
          } catch (e) {
            var f = {tag: "error", attr: [{reason: l}]};
            console.error(e), c(e), a.onClose(f)
          }
        }, function (a) {
          c("Failed to load service implementation: " + a)
        })
      };
      z.push(d)
    })
  }, A.prototype.loadImplJavascript = function () {
    var a = this, b = j();
    return b === e ? a.loadBrowserJavascript() : b === f ? a.loadNodeJSJavascript() : new Promise(function (a, c) {
      c("Unsupported environment: " + b)
    })
  }, A.prototype.loadBrowserJavascript = function () {
    var a = this, b = a.openEvent.content("service")[0], d = a.resolver, e = b.prop(c);
    return "function" == typeof d && (e = d.call(this, e)), console.log("Loading implementation: " + e), new Promise(function (c, d) {
      var f = document.createElement("script");
      e ? (console.log("Creating sparkl.service object"), D.service = function (b) {
        a.serviceImpl = new y(a, b)
      }, b.prop("nocache") && (e += -1 === e.indexOf("?") ? "?nocache=" + (new Date).getTime() : "&nocache=" + (new Date).getTime()), console.log("Loading implementation for " + b.id() + " from '" + e + "'"), f.setAttribute("type", "text/javascript"), f.setAttribute("src", e), f.addEventListener("load", function () {
        delete D.service, console.log("Loaded " + e + ", deleted sparkl.service"), f.parentNode.removeChild(f), c()
      }, !0), f.addEventListener("error", function () {
        var a = "Failed to load " + e + ", deleted sparkl.service";
        delete D.service, console.error(a), f.parentNode.removeChild(f), d(a)
      }, !0), document.getElementsByTagName("head")[0].appendChild(f)) : (console.warn(b.id() + ": No implementation, awaiting open events on dependent services"), c())
    })
  }, A.prototype.loadNodeJSJavascript = function () {
    var a = this, b = a.openEvent.content("service")[0], e = b.prop(d) || b.prop(c);
    return new Promise(function (b, c) {
      if (e) {
        console.log("Creating sparkl.service object"), D.service = function (b) {
          a.serviceImpl = new y(a, b)
        };
        try {
          require(e), b()
        } catch (f) {
          console.error(f), c("Failed to load module: " + e)
        }
      } else c("Missing service prop: " + d)
    })
  }, A.prototype.metadata = function () {
    var a, b, c = this, d = c.openEvent, e = c.aggregateEvents, f = new D.Struct({
      tag: "metadata",
      attr: {},
      content: []
    }), g = f.json.content;
    for (g.push.apply(g, d.json.content), a = 0; a < e.length; a++)b = e[a], g.push.apply(g, b.json.content);
    return f
  }, A.prototype.onInit = function (a) {
    var b = this;
    try {
      b.serviceImpl && b.serviceImpl.onInit(a)
    } catch (c) {
      console.error(c)
    }
  }, A.prototype.onAggregate = function (a) {
    var b = this;
    console.log("Aggregate event from: " + a.aggregatorInstanceId() + " (" + a.content()[0].name() + ")"), b.aggregateEvents.push(a)
  }, A.prototype.onClose = function (a) {
    var b = this;
    try {
      b.serviceImpl && b.serviceImpl.onClose(a)
    } catch (c) {
      console.error(c)
    }
    console.warn("Closed: " + b.openEvent.instanceId()), b.fireEvent("close", a)
  }, A.prototype.onOneWay = function (a) {
    var b = this, c = b.serviceImpl;
    b.fireEvent("oneway", a);
    try {
      c.onOneWay.apply(c, [a])
    } catch (d) {
      console.error(d)
    }
  }, A.prototype.onRequest = function (a) {
    var b = this, c = b.serviceImpl;
    b.fireEvent("request", a);
    try {
      c.onRequest.call(c, a)
    } catch (d) {
      console.error(d)
    }
  }, A.prototype.onResponse = function (a) {
    var b = this, c = b.pendingResponses, d = a.solicitId(), e = (a.inputName(), c[d]);
    e ? (console.log("Response to solicit id: " + d), delete c[d], e.fulfil(a), b.fireEvent("response", a)) : (l = "Response to unknown solicit: " + d, console.error(l))
  }, A.prototype.reply = function (a, b, c) {
    var d = this, e = {tag: "reply", replyTo: a.replyTo(), outputName: b, output: c};
    return new Promise(function (a, b) {
      d.connection.sendMessageAwaitAck(e).then(function () {
        a(), d.fireEvent("reply", e)
      }, function (a) {
        l = "Reply error: " + a, console.error(l), b(l)
      })
    })
  }, A.prototype.notify = function (a, b) {
    var c = this, d = {tag: "notification", instanceId: c.openEvent.instanceId(), opId: a, output: b || {}};
    return new Promise(function (a, b) {
      c.connection.sendMessageAwaitAck(d).then(function () {
        a(), c.fireEvent("notification", d)
      }, function (a) {
        b(a)
      })
    })
  }, A.prototype.solicit = function (a, b) {
    var c = this, d = c.connection.nextSolicitId(), e = {
      tag: "solicit",
      instanceId: c.openEvent.instanceId(),
      opId: a,
      solicitId: d,
      fields: b || {}
    };
    return new Promise(function (a, b) {
      c.connection.sendMessageAwaitAck(e).then(function () {
        var f = {fulfil: a, reject: b};
        c.pendingResponses[d] = f, c.fireEvent("solicit", e)
      }, function (a) {
        l = "Solicit error: " + a, console.error(l), b(l)
      })
    })
  };
  var B = function (a, b) {
    o.call(this, b), this.op = a
  };
  B.prototype = new o, B.prototype.send = function (a, b) {
    var c = this, d = c.op.id(), e = c.fieldValues;
    c.serviceInstance.solicit(d, e).then(a, b)
  };
  var C = function (a) {
    var b = this;
    if (b.json = "string" == typeof a ? JSON.parse(a) : a, b.json && b.json.tag) {
      if (b.json.attr)for (var c in b.json.attr)b.json.attr.hasOwnProperty(c) && !function (a) {
        b[a] || (b[a] = function () {
          return b.json.attr[a]
        })
      }(c)
    } else console.error(["Struct object must have 'tag' and 'attr' props", b.json])
  };
  C.prototype.tag = function () {
    var a = this;
    return a.json.tag
  }, C.prototype.attr = function (a) {
    var b = this;
    return a ? b.json.attr[a] : b.json.attr
  }, C.prototype.prop = function (a) {
    var b = this, c = b.content("prop", a), d = [];
    if (c instanceof Array) {
      for (var e = 0; e < c.length; e++)d.push(c[e].name());
      return d
    }
    return c && "number" === c.type() ? Number(c.content()) : c && c.content ? c.content() : void 0
  }, C.prototype.content = function () {
    var a = this, b = arguments[0], c = arguments[1];
    if ("undefined" == typeof b)return a.contentAll();
    if ("number" == typeof b)return a.contentAll()[b];
    if ("string" == typeof b) {
      if ("undefined" == typeof c)return a.contentWithTag(b);
      if ("string" == typeof c)return -1 === c.indexOf(" ") ? a.contentWithTagAndName(b, c) : a.contentWithTagAndNames(b, c.split(" "));
      if ("number" == typeof c)return a.contentWithTag(b)[c];
      if (c instanceof Array)return a.contentWithTagAndNames(b, c)
    }
    return !1
  }, C.prototype.contentWithTag = function (a) {
    var b = this, c = b.json.content, d = [];
    return c && c instanceof Array && c.every(function (b) {
      return b.tag && b.tag === a && d.push(new C(b)), !0
    }), d
  }, C.prototype.contentWithTagAndName = function (a, b) {
    var c = this, d = c.json.content, e = void 0;
    return d && d instanceof Array && d.some(function (c) {
      return !c.tag || c.tag !== a || c.attr.id !== b && c.attr.name !== b ? !1 : (e = new C(c), !0)
    }), e
  }, C.prototype.contentWithTagAndNames = function (a, b) {
    var c = this, d = c.json.content, e = [];
    return d && d instanceof Array && d.every(function (c) {
      return c.tag && c.tag === a && (b.indexOf(c.attr.id) >= 0 || b.indexOf(c.attr.name) >= 0) && e.push(new C(c)), !0
    }), e
  }, C.prototype.contentAll = function () {
    var a = this, b = a.json.content, c = [];
    return b && b instanceof Array && b.every(function (a) {
      return a.tag ? (c.push(new C(a)), !0) : (c = a, !1)
    }), c
  };
  var D = {Connection: p, ServiceInstance: A, Struct: C, service: null};
  "undefined" != typeof window && window.location && !window.location.getParam && (window.location.getParam = function (a) {
    a = a.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var b = "[\\?&]" + a + "=([^&#]*)", c = new RegExp(b), d = c.exec(window.location.search);
    return null == d ? "" : decodeURIComponent(d[1].replace(/\+/g, " "))
  }), "undefined" != typeof module && (module.exports = D), j() === e ? a.sparkl = D : j() === f ? module.exports = D : console.error("Unsupported environment")
}(this);